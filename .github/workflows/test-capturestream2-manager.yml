name: Test CaptureStream2 Manager

on:
  push:
    paths:
      - 'capturestream2-manager.sh'
      - '.github/workflows/test-capturestream2-manager.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: チェックアウト
        uses: actions/checkout@v3

      - name: Homebrew tap 追加
        run: |
          brew tap CSReviser/capturestream2

      - name: スクリプトに実行権限付与
        run: chmod +x ./capturestream2-manager.sh

      - name: 最新版インストール
        run: ./capturestream2-manager.sh <<< "1"

      - name: 一覧表示テスト
        run: ./capturestream2-manager.sh <<< "5"

      - name: バージョン一覧取得（ログ用）
        run: brew search capturestream2

      - name: ロールバック（自動選択）
        run: |
          VERSION=$(brew search capturestream2 | grep -E 'capturestream2@' | head -n 1 | sed 's/^capturestream2@//')
          echo "Testing rollback version: $VERSION"
          brew install --cask "capturestream2@${VERSION}"

      - name: ロールバック解除
        run: |
          VERSION=$(brew search capturestream2 | grep -E 'capturestream2@' | head -n 1 | sed 's/^capturestream2@//')
          brew uninstall --cask "capturestream2@${VERSION}"
          brew reinstall --cask capturestream2