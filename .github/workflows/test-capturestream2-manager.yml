name: Test CaptureStream2 Manager

on:
  push:
    paths:
      - "capturestream2-manager.sh"
  workflow_dispatch:

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Install Homebrew (if needed)
        run: |
          command -v brew >/dev/null 2>&1 || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: Tap capturestream2
        run: |
          brew tap CSReviser/homebrew-capturestream2
          brew update

      - name: Test Install Latest
        run: brew install --cask capturestream2

      - name: Test Upgrade
        run: brew upgrade --cask capturestream2 || true

      - name: Test Reinstall
        run: brew reinstall --cask capturestream2

      - name: List installed casks
        run: brew list --cask

      - name: Detect rollback version (first found)
        id: rollback
        run: |
          version=$(brew search capturestream2 | grep -E 'capturestream2@[0-9]{8}' | sed 's|.*/||' | head -n 1)
          echo "Selected rollback version: $version"
          if [[ -z "$version" ]]; then
            echo "No rollback version found!"
            exit 1
          fi
          echo "rollback_version=$version" >> "$GITHUB_OUTPUT"

      - name: Test Install rollback version
        run: brew install --cask ${{ steps.rollback.outputs.rollback_version }}

      - name: Test Uninstall rollback version
        run: brew uninstall --cask ${{ steps.rollback.outputs.rollback_version }}

      - name: Test Reinstall Latest
        run: brew reinstall --cask capturestream2